{
  "name": "BCKP workflows n8n to GitHub",
  "active": false,
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM workflow_entity\nWHERE name NOT ILIKE '%backup%'\nORDER BY id;",
        "additionalFields": {}
      },
      "name": "Get Workflows from DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        -432,
        224
      ],
      "id": "619dae1f-ee40-4904-97a5-cad13c8779db",
      "credentials": {
        "postgres": {
          "id": "2xkaCrgCVOfCETb3",
          "name": "PostgreSQL credential n8n_database"
        }
      }
    },
    {
      "parameters": {
        "resource": "file",
        "owner": {
          "__rl": true,
          "value": "paul-z4z",
          "mode": "name"
        },
        "repository": {
          "__rl": true,
          "value": "n8n_Workflows",
          "mode": "name"
        },
        "filePath": "={{ $json.path }}",
        "fileContent": "={{ $json.content }}",
        "commitMessage": "={{ $json.message }}"
      },
      "name": "Upload to GitHub",
      "type": "n8n-nodes-base.github",
      "typeVersion": 1,
      "position": [
        16,
        224
      ],
      "id": "e14e803b-841e-460b-b477-7a4bbd448d3b",
      "webhookId": "09d821d4-6a0a-4991-be00-6a2ec5dff456",
      "credentials": {
        "githubApi": {
          "id": "9RWBslDcc6pPEYjG",
          "name": "GitHub backup"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 8
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -640,
        224
      ],
      "id": "e1b95e1b-aef9-4180-bb73-e6d5f7a09a3a",
      "name": "Weekly Cleanup Trigger"
    },
    {
      "parameters": {
        "jsCode": "const workflows = items.map(item => item.json);\nconst timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);\n\nconst files = workflows.flatMap(workflow => {\n  const cleanName = workflow.name.replace(/[^a-zA-Z0-9]/g, '_');\n  const workflowId = workflow.id;\n  const workflowJson = JSON.stringify(workflow, null, 2);\n\n  return [\n    {\n      path: `individual/${cleanName}_${workflowId}/${cleanName}_${timestamp}.json`,\n      content: Buffer.from(workflowJson).toString('base64'),\n      message: `Backup ${cleanName} (${workflowId}) at ${timestamp}`\n    }\n  ];\n});\n\n// Add combined timestamped file\nconst allWorkflowsJson = JSON.stringify(workflows, null, 2);\nfiles.push({\n  path: `all_workflows/all_workflows_${timestamp}.json`,\n  content: Buffer.from(allWorkflowsJson).toString('base64'),\n  message: `Full backup of all workflows at ${timestamp}`\n});\n\nreturn files.map(file => ({ json: file }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        48
      ],
      "id": "d6c4176a-e8cf-415e-be80-5930e3e3707a",
      "name": "Code"
    },
    {
      "parameters": {
        "jsCode": "const workflows = items.map(item => item.json);\nconst now = new Date();\nconst timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19); // 2025-08-29T14-30-15\n\n// Create output array for multiple files\nconst outputFiles = [];\n\nworkflows.forEach((workflow, index) => {\n  // Create clean filename from workflow name\n  const workflowName = workflow.name \n    ? workflow.name.replace(/[^a-zA-Z0-9-_\\s]/g, '').replace(/\\s+/g, '-').toLowerCase()\n    : `workflow-${index + 1}`;\n  \n  // Clean workflow data\n  const cleanWorkflow = { ...workflow };\n  \n  // Current timestamped backup file\n  const backupFileName = `${workflowName}_${timestamp}.json`;\n  \n  outputFiles.push({\n    json: {\n      path: backupFileName,\n      content: Buffer.from(JSON.stringify(cleanWorkflow, null, 2)).toString('base64'),\n      message: `Backup workflow: ${workflowName} at ${timestamp}`,\n      // Add metadata for the GitHub cleanup action to identify related files\n      workflow_name: workflowName,\n      is_workflow_backup: true\n    }\n  });\n});\n\n// Create a cleanup instruction file that your GitHub workflow can use\n// This helps identify which old files to delete\nconst cleanupInstructions = {\n  backup_timestamp: timestamp,\n  workflow_names: workflows.map((workflow, index) => \n    workflow.name \n      ? workflow.name.replace(/[^a-zA-Z0-9-_\\s]/g, '').replace(/\\s+/g, '-').toLowerCase()\n      : `workflow-${index + 1}`\n  ),\n  retention_count: 5,\n  instruction: \"Keep only the 5 most recent backup files per workflow, delete older ones\"\n};\n\noutputFiles.push({\n  json: {\n    path: `_cleanup_${timestamp}.json`,\n    content: Buffer.from(JSON.stringify(cleanupInstructions, null, 2)).toString('base64'),\n    message: `Cleanup instructions for backup ${timestamp}`,\n    is_cleanup_instruction: true\n  }\n});\n\nreturn outputFiles;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        224
      ],
      "id": "73deb1e5-5a39-43fe-ae45-29f06fe7e8ee",
      "name": "Code1"
    }
  ],
  "connections": {
    "Get Workflows from DB": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to GitHub": {
      "main": [
        []
      ]
    },
    "Weekly Cleanup Trigger": {
      "main": [
        [
          {
            "node": "Get Workflows from DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Upload to GitHub",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-26T17:42:18.102Z",
  "updatedAt": "2025-08-30T01:41:42.934Z",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "node:Weekly Cleanup Trigger": {
      "recurrenceRules": [
        16
      ]
    }
  },
  "pinData": {},
  "versionId": "31aa4074-8a74-4899-a0a6-ede7a558dd09",
  "triggerCount": 1,
  "id": "4PfmBxWJsJcMqQ9F",
  "meta": null,
  "parentFolderId": null,
  "isArchived": false
}